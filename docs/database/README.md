# ã‚ªãƒ¤ã‚«ãƒ„ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

## æ¦‚è¦

PostgreSQLã‚’ä½¿ç”¨ã—ãŸãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã§ã™ã€‚
ORMã¯Prismaã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

- `schema.prisma` - Prismaã‚¹ã‚­ãƒ¼ãƒå®šç¾©
- `erd.md` - ERå›³ï¼ˆMermaidå½¢å¼ï¼‰

## ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§

### ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£

| ãƒ†ãƒ¼ãƒ–ãƒ«å | èª¬æ˜ |
|-----------|------|
| `users` | ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± |
| `device_tokens` | ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ç”¨ãƒ‡ãƒã‚¤ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ |
| `refresh_tokens` | JWTãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ |
| `verification_codes` | SMS/ãƒ¡ãƒ¼ãƒ«èªè¨¼ã‚³ãƒ¼ãƒ‰ |

### ãƒ•ã‚¡ãƒŸãƒªãƒ¼é–¢é€£

| ãƒ†ãƒ¼ãƒ–ãƒ«å | èª¬æ˜ |
|-----------|------|
| `families` | ãƒ•ã‚¡ãƒŸãƒªãƒ¼æƒ…å ± |
| `family_members` | ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ¡ãƒ³ãƒãƒ¼ |

### å ±é…¬è¨­å®š

| ãƒ†ãƒ¼ãƒ–ãƒ«å | èª¬æ˜ |
|-----------|------|
| `reward_settings` | è¦ªâ†’å­ä¾›ã”ã¨ã®å ±é…¬è¨­å®š |

### é€šè©±é–¢é€£

| ãƒ†ãƒ¼ãƒ–ãƒ«å | èª¬æ˜ |
|-----------|------|
| `call_requests` | é€šè©±ãƒªã‚¯ã‚¨ã‚¹ãƒˆ |
| `calls` | é€šè©±å±¥æ­´ |

### å†™çœŸé–¢é€£

| ãƒ†ãƒ¼ãƒ–ãƒ«å | èª¬æ˜ |
|-----------|------|
| `photos` | å†™çœŸ |
| `photo_recipients` | å†™çœŸã®é€ä¿¡å…ˆï¼ˆå€‹åˆ¥é€ä¿¡ç”¨ï¼‰ |
| `reactions` | ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |

### å ±é…¬é–¢é€£

| ãƒ†ãƒ¼ãƒ–ãƒ«å | èª¬æ˜ |
|-----------|------|
| `rewards` | å ±é…¬å±¥æ­´ |

### ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ»ç§°å·

| ãƒ†ãƒ¼ãƒ–ãƒ«å | èª¬æ˜ |
|-----------|------|
| `titles` | ç§°å·ãƒã‚¹ã‚¿ãƒ¼ |
| `rankings` | æœˆé–“ãƒ©ãƒ³ã‚­ãƒ³ã‚° |

### é€šçŸ¥

| ãƒ†ãƒ¼ãƒ–ãƒ«å | èª¬æ˜ |
|-----------|------|
| `notifications` | é€šçŸ¥ |
| `notification_settings` | é€šçŸ¥è¨­å®š |

## Enumå®šç¾©

### user_role
- `parent` - è¦ª
- `child` - å­ä¾›

### device_platform
- `ios`
- `android`

### verification_code_type
- `phone` - é›»è©±ç•ªå·èªè¨¼
- `email` - ãƒ¡ãƒ¼ãƒ«èªè¨¼

### family_member_status
- `active` - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
- `left` - è„±é€€æ¸ˆã¿

### call_reward_type
- `fixed` - 1å›ã‚ãŸã‚Šå›ºå®š
- `per_minute` - 1åˆ†ã‚ãŸã‚Š

### call_request_status
- `pending` - ä¿ç•™ä¸­
- `accepted` - æ‰¿è«¾
- `declined` - æ‹’å¦
- `expired` - æœŸé™åˆ‡ã‚Œ

### call_type
- `video` - ãƒ“ãƒ‡ã‚ªé€šè©±
- `audio` - éŸ³å£°é€šè©±

### call_status
- `ongoing` - é€šè©±ä¸­
- `completed` - å®Œäº†
- `missed` - ä¸åœ¨

### photo_visibility
- `all` - å…¨å“¡ã«å…¬é–‹
- `specific` - ç‰¹å®šãƒ¡ãƒ³ãƒãƒ¼ã®ã¿

### reaction_type
- `heart` - â¤ï¸
- `smile` - ğŸ˜Š
- `clap` - ğŸ‘
- `cry` - ğŸ˜¢

### reward_source
- `call` - é€šè©±
- `photo` - å†™çœŸ

### reward_status
- `pending` - æœªå—é ˜
- `confirmed` - å—é ˜ç¢ºèªæ¸ˆã¿

### notification_type
- `call_request` - é€šè©±ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- `photo_posted` - å†™çœŸæŠ•ç¨¿
- `reward_received` - å ±é…¬å—é ˜
- `title_changed` - ç§°å·å¤‰æ›´
- `ranking_changed` - ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¤‰æ›´

## ä¸»è¦ãªãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ•ã‚¡ãƒŸãƒªãƒ¼
```
User 1---* FamilyMember *---1 Family
```
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¤‡æ•°ã®ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã«æ‰€å±å¯èƒ½ï¼ˆãŸã ã—role=childã¯1ã¤ã®ã¿ï¼‰
- ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã«ã¯è¤‡æ•°ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒæ‰€å±

### å ±é…¬è¨­å®š
```
Family 1---* RewardSetting
RewardSetting *---1 User (parent)
RewardSetting *---1 User (child)
```
- è¦ªã¯å­ä¾›ã”ã¨ã«å ±é…¬è¨­å®šã‚’æŒã¤
- åŒã˜ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ»è¦ªãƒ»å­ä¾›ã®çµ„ã¿åˆã‚ã›ã¯ä¸€æ„

### é€šè©±ã¨å ±é…¬
```
CallRequest 1---0..1 Call
Call 1---* Reward
```
- é€šè©±ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰é€šè©±ãŒé–‹å§‹
- é€šè©±çµ‚äº†æ™‚ã«å ±é…¬ãŒç”Ÿæˆ

### å†™çœŸã¨å ±é…¬
```
Photo 1---* Reward
Photo 1---* Reaction
Photo 1---* PhotoRecipient
```
- å†™çœŸæŠ•ç¨¿æ™‚ã«å ±é…¬ãŒç”Ÿæˆ
- å†™çœŸã«ã¯ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒä»˜ã

## ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡è¦–ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

| ãƒ†ãƒ¼ãƒ–ãƒ« | ã‚«ãƒ©ãƒ  | ç”¨é€” |
|---------|--------|------|
| `call_requests` | `callee_id, status` | å—ä¿¡ã—ãŸé€šè©±ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ |
| `call_requests` | `expires_at` | æœŸé™åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯ |
| `calls` | `family_id, started_at` | é€šè©±å±¥æ­´ä¸€è¦§ |
| `photos` | `family_id, uploaded_at` | ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º |
| `photos` | `expires_at` | æœŸé™åˆ‡ã‚Œå‰Šé™¤ |
| `rewards` | `family_id, created_at` | å ±é…¬å±¥æ­´ä¸€è¦§ |
| `rewards` | `child_id, status` | æœªå—é ˜å ±é…¬ä¸€è¦§ |
| `rewards` | `parent_id, created_at` | è¦ªã®æ”¯æ‰•ã„å±¥æ­´ |
| `rankings` | `family_id, month, rank` | ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º |
| `notifications` | `user_id, created_at` | é€šçŸ¥ä¸€è¦§ |
| `notifications` | `user_id, is_read` | æœªèª­é€šçŸ¥ã‚«ã‚¦ãƒ³ãƒˆ |

## åˆæœŸãƒ‡ãƒ¼ã‚¿

### ç§°å·ãƒã‚¹ã‚¿ãƒ¼
```sql
INSERT INTO titles (id, name, icon, min_amount, max_amount, sort_order) VALUES
  ('watcher', 'è¦‹å®ˆã‚ŠéšŠ', 'ğŸ‘€', 0, 9999, 1),
  ('supporter', 'å¿ƒã®æ”¯ãˆ', 'ğŸ’–', 10000, 49999, 2),
  ('super_fan', 'ç¥æ¨ã—', 'ğŸ–ï¸', 50000, NULL, 3);
```

## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```bash
# Prismaãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ
npx prisma migrate dev --name init

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ï¼ˆæœ¬ç•ªï¼‰
npx prisma migrate deploy

# ã‚¹ã‚­ãƒ¼ãƒåŒæœŸï¼ˆé–‹ç™ºï¼‰
npx prisma db push
```

## ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥

- æ—¥æ¬¡: ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- æ¯æ™‚: WALï¼ˆWrite-Ahead Logï¼‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- ä¿æŒæœŸé–“: 30æ—¥

## ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼

| ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ | ä¿æŒæœŸé–“ | å‰Šé™¤æ–¹æ³• |
|-----------|---------|---------|
| å†™çœŸ | 1å¹´ | `expires_at`ã§ãƒãƒƒãƒå‰Šé™¤ |
| é€šè©±å±¥æ­´ | ç„¡æœŸé™ | - |
| å ±é…¬å±¥æ­´ | ç„¡æœŸé™ | - |
| èªè¨¼ã‚³ãƒ¼ãƒ‰ | 10åˆ† | `expires_at`ã§ãƒãƒƒãƒå‰Šé™¤ |
| ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ | 30æ—¥ | `expires_at`ã§ãƒãƒƒãƒå‰Šé™¤ |
| é€šè©±ãƒªã‚¯ã‚¨ã‚¹ãƒˆ | 24æ™‚é–“ | `expires_at`ã§è‡ªå‹•expired |
